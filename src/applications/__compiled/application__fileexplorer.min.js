/**
Systems OS - 0.0.1

Copyright (c) 2018 Isart Navarro Farell
License: MIT
*/
var fileexplorerApp = angular.module('fileexplorerApp', []);

(function () {
	"use strict";
	fileexplorerApp.run(['ApplicationsFactory', function(ApplicationsFactory) {

		ApplicationsFactory.registerApplication({
			id: "fileexplorer",
			ico: "folder",
			name: "File Explorer",
			menu: true,
			actions: false,
			status: false,
			style: "width:770px;height:600px;top:9%;left:12%;"
		});

	}]);
}());

(function () {
	"use strict";
	fileexplorerApp.controller('feBodyController', ['$rootScope', '$scope', '$timeout', 'fileSystemFactory', 'Upload', 'ApplicationsFactory',
		function ($rootScope, $scope, $timeout, fileSystemFactory, Upload, ApplicationsFactory) {

		var _this = this;
		this.viewAsList = false;
		this.showModal = false;
		this.currentActive = 0;
		this.selection = true;
		this.cutfrom = null;
		this.copyFrom = null;
		this.pasteTo = null;
		this.lastPath = [];
		this.nextPath = [];


		/*
		 * Init
		 */

		// Set root path as a current path
		this.localFileSystem = {
			currentPath: "/",
			currentData: ""
		};

		/*
		 * Get root path files
		 */
		fileSystemFactory.getFileSystemPath('/', function (data) {
			_this.localFileSystem.currentData = data;
			$(".folders").focus();
		});

		/*
		 * Bindings
		 */
		$scope.$watch(function () {
			return _this.uploadFiles;
		}, function (files) {
			if (files != null) {
				// make files array for not multiple to be able to be used in ng-repeat in the ui
				if (!angular.isArray(files)) {
					$timeout(function () {
						_this.uploadFiles = files = [files];
					});
					return;
				}

				// Upload each file
				for (var i = 0; i < files.length; i++) {
					(function (f) {
						fileSystemFactory.uploadFile(f).then(function (data) {
							if (data.status === "ok") {
								_this.reloadPath();
							}
						});
					})(files[i]);
				}
			}
		});

		/*
		 * Current path contextmenu
		 */
		this.localContextMenu = [
			{
				text: '<i class="fa fa-download"></i> Download from URL to current folder',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

					_this.modalType = "Download from url";
					_this.fileUrl = "";
					_this.showModal = true;
				}
			},
			null,
			[function () {
				return '<i class="fa fa-clipboard"></i> Paste';
			}, function ($itemScope) {
				if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

				_this.pasteTo = _this.localFileSystem.currentPath;
				console.log(_this.copyFrom);
				console.log(_this.pasteTo);

				// TODO: Do something

				_this.copyFrom = null;
				_this.pasteTo = null;
			}, function () {
				if (_this.copyFrom === null) return false;
				return true; // enabled = true, disabled = false
			}],
			null,
			{
				text: '<i class="fa fa-lock"></i> Permissions',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;


				}
			}

		];

		/*
		 * File contextmenu
		 */
		this.fileContextMenu = [
			{
				text: '<i class="fa fa-download"></i> Download to local',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;


				}
			},
			[function ($itemScope) {
				if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

				var filetype = _this.getFileType($itemScope.file.longname);

				if (filetype === "folder") {
					return '<i class="fa fa-folder-open"></i> Open';
				} else {
					return '<i class="fa fa-edit"></i> Open with Notepad';
				}
			}, function ($itemScope) {
				if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;
				_this.doWithFile($itemScope.file)
			}, function () {
				// Enable or Disable
				return true; // enabled = true, disabled = false
			}],
			null,
			{
				text: '<i class="fa fa-files-o"></i> Copy',
				click: function ($itemScope, $event, modelValue, text, $li) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

					_this.cutFrom = null;
					_this.copyFrom = _this.localFileSystem.currentPath + $itemScope.file.filename;
				}
			},
			[function () {
				return '<i class="fa fa-clipboard"></i> Paste';
			}, function ($itemScope) {
				if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

				_this.pasteTo = _this.localFileSystem.currentPath;
				console.log(_this.copyFrom);
				console.log(_this.pasteTo);

				// TODO: Do something

				_this.copyFrom = null;
				_this.pasteTo = null;
			}, function () {
				if (_this.copyFrom === null) return false;
				return true; // enabled = true, disabled = false
			}],
			{
				text: '<i class="fa fa-scissors"></i> Cut',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

					_this.copyFrom = null;
					_this.cutFrom = _this.localFileSystem.currentPath + $itemScope.file.filename;
				}
			},
			null,
			{
				text: '<i class="fa fa-font"></i> Rename',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

					_this.modalType = "Rename";
					_this.fileToRename = $itemScope.file.filename;
					_this.modalInputName = $itemScope.file.filename;
					_this.showModal = true;
				}
			},
			{
				text: '<i class="fa fa-remove"></i> Delete',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;

					_this.modalType = "Delete File";
					_this.modalInputName = $itemScope.file.filename;
					_this.showModal = true;
				}
			},
			null,
			{
				text: '<i class="fa fa-lock"></i> Permissions',
				click: function ($itemScope) {
					if (angular.isUndefined($itemScope.file)) $itemScope.file = $itemScope.$parent.file;


				}
			}
		];

		/*
		 * Get file type (folder, file...)
		 */
		this.getFileType = function (longname) {
			return fileSystemFactory.getFileType(longname);
		};

		/*
		 * Get all contents from given folder path
		 */
		this.getFolderContents = function (newPath) {
			fileSystemFactory.getFileSystemPath(newPath, function (data) {
				_this.search = undefined;
				_this.localFileSystem.currentData = data;
				_this.localFileSystem.currentPath = newPath;
				_this.resetActive();
			});
		};

		/*
		 * ng-click functions
		 */

		/*
		 * Checks if is a file or folder and do something
		 */
		this.doWithFile = function (file) {
			var filetype = _this.getFileType(file.longname);

			if (filetype === "folder") {
				var newPath = _this.localFileSystem.currentPath + file.filename + '/';

				// Push the actual path to lastPath array (used by goPathBack())
				_this.lastPath.push(_this.localFileSystem.currentPath);
				// Reset nextPath
				_this.nextPath = [];

				_this.getFolderContents(newPath);

			} else {
				var filePath = _this.localFileSystem.currentPath + file.filename;

				fileSystemFactory.getFileContents(filePath, function (data) {
					ApplicationsFactory.openApplication("notepad");
					ApplicationsFactory.toggleApplication("notepad");

					$timeout(function () {
						$rootScope.$broadcast("notepad__new_data", data);
					}, 100);

				});
			}
		};

		/*
		 * Go to any folders by a given path
		 */
		this.goToPath = function ($index) {
			var newPath = _this.localFileSystem.currentPath.split('/').splice(0, $index + 1).join('/') + '/';

			// Push the actual path to lastPath array (used by goPathBack())
			_this.lastPath.push(_this.localFileSystem.currentPath);
			// Reset nextPath
			_this.nextPath = [];

			_this.getFolderContents(newPath);
		};

		/*
		 * Checks the last visited path and go to it
		 */
		this.goPathBack = function () {
			if (_this.lastPath.length === 0) return;
			var newPath = _this.lastPath.pop();

			// Push the actual path to nextPath array (used by goPathForward())
			_this.nextPath.push(_this.localFileSystem.currentPath);

			_this.getFolderContents(newPath);
		};

		/*
		 * If called goPathBack this function goes a path forward
		 */
		this.goPathForward = function () {
			if (_this.nextPath.length === 0) return;
			var newPath = _this.nextPath.pop();

			// Push the actual path to nextPath array (used by goPathForward())
			_this.lastPath.push(_this.localFileSystem.currentPath);

			_this.getFolderContents(newPath);
		};

		/*
		 * Get current path data
		 */
		this.reloadPath = function () {
			fileSystemFactory.getFileSystemPath(_this.localFileSystem.currentPath, function (data) {
				_this.search = undefined;
				_this.localFileSystem.currentData = data;
				_this.resetActive();
			});
		};

		/*
		 * Sets view mode (icons, detailed...)
		 */
		this.toggleView = function () {
			_this.viewAsList = !_this.viewAsList;
			_this.resetActive();
		};

		/*
		 * Creates a new folder
		 */
		this.createFolder = function () {
			_this.modalType = "Create Folder";
			_this.modalInputName = "New Folder";
			_this.showModal = true;
		};

		/*
		 * Deletes selected files or folders
		 */
		this.deleteSelected = function () {
			fileSystemFactory.deleteFile(_this.localFileSystem.currentPath, _this.modalInputName, function (data) {
				_this.reloadPath();
				_this.showModal = false;
			});
		};

		/*
		 * Sets the fist item in the current path as active
		 */
		this.resetActive = function () {
			_this.currentActive = 0;
			$("#local_body").focus();
		};

		/*
		 * Sets an item file/folder active
		 */
		this.setCurrentActive = function ($index) {
			$("#local_body").focus();
			$timeout.cancel(_this.selectTimeout);

			if ($index > _this.localFileSystem.currentData.length - 1) {
				_this.currentActive = 0;
			} else if ($index < 0) {
				_this.currentActive = _this.localFileSystem.currentData.length - 1;
			} else {
				_this.currentActive = $index;
			}

			_this.selection = false;
			_this.selectTimeout = $timeout(function () {
				_this.selection = true;
			}, 100);
		};

		/*
		 * Keypress on item focus
		 */
		this.handleItemKeyPress = function (keyEvent) {
			console.log(keyEvent);
			if (_this.showModal === true) return;

			if (keyEvent.which === 46) {
				_this.modalType = "Delete File";
				_this.modalInputName = _this.localFileSystem.currentData[_this.currentActive].filename;
				_this.showModal = true;
			} else if (keyEvent.which === 113) {
				_this.modalType = "Rename";
				_this.fileToRename = _this.localFileSystem.currentData[_this.currentActive].filename;
				_this.modalInputName = _this.localFileSystem.currentData[_this.currentActive].filename;
				_this.showModal = true;
			} else if (keyEvent.which === 39) {
				_this.setCurrentActive(_this.currentActive + 1);
			} else if (keyEvent.which === 37) {
				_this.setCurrentActive(_this.currentActive - 1);
			} else if (keyEvent.which === 8) {
				// go back
			} else if (keyEvent.which === 13) {
				_this.doWithFile(_this.localFileSystem.currentData[_this.currentActive]);
			}
		};

		/*
		 * Keypress on action modal
		 */
		this.handleKeyPress = function (keyEvent) {
			console.log(keyEvent);
			if (keyEvent.which === 13) {
				if (_this.modalType === "Rename") {
					fileSystemFactory.renameFile(_this.localFileSystem.currentPath, _this.fileToRename, _this.modalInputName, function () {
						_this.reloadPath();
						_this.showModal = false;
					});
				} else if (_this.modalType === "Create Folder") {
					fileSystemFactory.createFolder(_this.localFileSystem.currentPath, _this.modalInputName, function () {
						_this.reloadPath();
						_this.showModal = false;
					});
				} else if (_this.modalType === "Delete File") {
					fileSystemFactory.deleteFile(_this.localFileSystem.currentPath, _this.modalInputName, function () {
						_this.reloadPath();
						_this.showModal = false;
					});
				} else if (_this.modalType === "Download from url") {
					fileSystemFactory.downloadFileFromInet(_this.fileUrl, _this.localFileSystem.currentPath, function () {
						_this.reloadPath();
						_this.showModal = false;
					});
				}
			} else if (keyEvent.which === 27) {
				_this.showModal = false;
				_this.resetActive();
			}
		};


	}]);
}());
(function () {
	"use strict";
	fileexplorerApp.run(['$templateCache', function ($templateCache) {

		$templateCache.put('templates/applications/actions-fe-local.html',
			'<div class="window__actions"> \
			  <span class="fa-stack" ng-click="feB.createFolder();"> \
				<i class="fa fa-folder fa-stack-1x"></i> \
				<i class="fa fa-plus fa-pull-right fa-stack-1x text-success"></i> \
			  </span> \
			  <a class="window__item" ng-click="feB.toggleView()"> \
				<i class="fa fa-list"></i> \
			  </a> \
			  <a class="window__item separator"></a> \
			  <a class="window__back" ng-click="feB.goPathBack()"> \
				<i class="fa fa-arrow-left"></i> \
			  </a> \
			  <a class="window__forward" ng-click="feB.goPathForward()"> \
				<i class="fa fa-arrow-right"></i> \
			  </a> \
			  <a class="window__item" ng-click="feB.reloadPath()"> \
				<i class="fa fa-refresh"></i> \
			  </a> \
			  <div class="window__path"> \
				<a ng-click="feB.goToPath(null)"> \
				  <i class="fa fa-desktop"></i> \
				  SysOS / \
				</a> \
				<a ng-repeat="path in feB.localFileSystem.currentPath.split(\'/\') track by $index" ng-if="path.length != 0" ng-click="feB.goToPath($index, path)"> \
				  {{::path}} \
				</a> \
			  </div> \
			  <form class="search"> \
				<input type="text" class="search__input" placeholder="Search files" ng-model="feB.search.filename"> \
				<button class="search__btn"> \
				</button> \
			  </form> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	fileexplorerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/body-fileexplorer.html',
			'<div class="window__body" ng-controller="feBodyController as feB"> \
			  <div class="window__side"> \
				<ul class="side__list"> \
				  <li><a >Home</a></li> \
				  <li> \
					<a > \
					  Favorites \
					  <span class="list__toggle" ng-click="BODY.toggleList($event)"></span> \
					</a> \
					<ul style="display:none"> \
					  <li><a >Desktop</a></li> \
					  <li><a >Downloads</a></li> \
					  <li><a >Recent Places</a></li> \
					</ul> \
				  </li> \
				  <li> \
					<a > \
					  This Device \
					  <span class="list__toggle" ng-click="BODY.toggleList($event)"></span> \
					</a> \
					<ul style="display:none"> \
					  <li> \
						<a >Desktop</a> \
						<ul style="display:none"> \
						  <li> \
							<a >Folder 1</a> \
						  </li> \
						</ul> \
					  </li> \
					  <li><a >Documents</a></li> \
					  <li><a >Downloads</a></li> \
					  <li><a >Local Disk  (C:)</a></li> \
					</ul> \
				  </li> \
				</ul> \
			  </div> \
			  <div class="window__main no_padding"> \
				<div class="col-xs-12 ftp__body" > \
					<div ng-include="\'templates/applications/actions-fe-local.html\'" include-replace></div> \
					<div id="local_body" selectable="feB.selection" selectable-list="feB.localFileSystem.currentData | filter:feB.search" selectable-out="selected" selectable-options="{delay:150, filter: \'a\'}" minus-index="2" class="folders" tabindex="0" ng-keydown="feB.handleItemKeyPress($event)" context-menu="feB.localContextMenu"> \
					<div ng-include="\'templates/applications/folders-modal-fe-local.html\'"></div> \
					<div ng-include="\'templates/applications/folders-dropzone-fe-local.html\'"></div> \
					<a ng-if="feB.viewAsList == false"  ng-repeat="file in feB.localFileSystem.currentData | filter:feB.search" ng-class="{\'active\': feB.currentActive == $index}" ng-click="feB.setCurrentActive($index)" ng-dblclick="feB.doWithFile(file)" title="{{::file.filename}}" context-menu="feB.fileContextMenu"> \
					<i class="fa fa-{{::feB.getFileType(file.longname)}}"></i> \
					<span>{{::file.filename}}</span> \
				</a> \
				<table ng-if="feB.viewAsList == true" class="table table-hover"> \
					<thead> \
					<tr> \
					<th>Name</th> \
					<th>Size</th> \
					<th>Type</th> \
					</tr> \
					</thead> \
					<tbody> \
					<tr ng-repeat="file in feB.localFileSystem.currentData | filter:feB.search" ng-class="{\'active\': feB.currentActive == $index}" ng-click="feB.setCurrentActive($index)" ng-dblclick="feB.doWithFile(file)" title="{{::file.filename}}" context-menu="feB.fileContextMenu"> \
					<td><i class="fa fa-{{::feB.getFileType(file.longname)}}"></i> {{::file.filename}}</td> \
				<td>{{::file.attrs.size}}</td> \
				<td>{{::feB.getFileType(file.longname)}}</td> \
				</tr> \
				</tbody> \
				</table> \
				</div> \
				</div> \
			  </div> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	fileexplorerApp.run(['$templateCache', function ($templateCache) {

		$templateCache.put('templates/applications/folders-dropzone-fe-local.html',
			'<div class="dropzone" ngf-drop ngf-select \
			ng-model="feB.uploadFiles" \
			ngf-model-options="{debounce:100}" \
			ngf-multiple="true" \
			ngf-drag-over-class="{dragover}" \
			ngf-allow-dir="true"  \
			ngf-drop-available="true"> \
			  Drop files here (from local system) or click to upload. \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	fileexplorerApp.run(['$templateCache', function ($templateCache) {

		$templateCache.put('templates/applications/folders-modal-fe-local.html',
			'<div class="folders-modal" ng-if="feB.showModal" ng-switch="feB.modalType"> \
			  <h3>{{feB.modalType}}</h3> \
			  <input ng-switch-when="Download from url" type="text" class="form-control" set-focus ng-model="feB.fileUrl" placeholder="Enter url" ng-keydown="feB.handleKeyPress($event)"> \
			  <input ng-switch-when="Rename" type="text" class="form-control" set-focus ng-model="feB.modalInputName" placeholder="Enter new name" ng-keydown="feB.handleKeyPress($event)"> \
			  <input ng-switch-when="Create Folder" type="text" class="form-control" set-focus ng-model="feB.modalInputName" placeholder="Enter folder Name" ng-keydown="feB.handleKeyPress($event)"> \
			  <div ng-switch-when="Delete File"> \
				<span>Delete confirmation for file {{feB.modalInputName}}</span><br /> \
				<button type="button" class="btn btn-primary" set-focus ng-keydown="feB.handleKeyPress($event)" ng-click="feB.deleteSelected()">Delete</button> \
				<button type="button" class="btn" ng-click="feB.showModal = !feB.showModal; feB.resetActive()">Cancel</button> \
			  </div> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	fileexplorerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/menu-fileexplorer.html',
			'<li> \
		  <a > \
			<i class="menu__icon fa fa-search"></i> \
			Search \
		  </a> \
		</li> \
		<li> \
		  <a > \
			<i class="menu__icon fa fa-share-alt"></i> \
			Share \
		  </a> \
		</li> \
		<li> \
		  <a > \
			<i class="menu__icon fa fa-plug"></i> \
			Devices \
		  </a> \
		</li> \
		<li class="divided"> \
		  <a > \
			<i class="menu__icon fa fa-cog"></i> \
			Settings \
		  </a> \
		</li>'
		);

	}]);
}());
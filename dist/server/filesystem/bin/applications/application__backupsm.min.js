/**
Systems OS - 0.0.1

Copyright (c) 2018 Isart Navarro Farell
License: MIT
*/
var backupsmApp = angular.module('backupsmApp', []);

(function () {
	"use strict";
	backupsmApp.run(['ApplicationsFactory', 'ServerFactory', 'backupsmFactory', function(ApplicationsFactory, ServerFactory, backupsmFactory) {

		ApplicationsFactory.registerApplication({
			id: "backupsm",
			ico: "hdd-o",
			name: "Backups Manager",
			menu: true,
			actions: true,
			style: "width:870px;height:600px;top:7%;left:10%;"
		});

		// Get restores
		ServerFactory
		.getConfigFile('applications/backupsm/restores.json', function (data) {
			return backupsmFactory.setRestores(data.data);
		}, function (data) {
			console.log("Error");
		});

	}]);
}());
(function () {
	"use strict";
	backupsmApp.controller('bmActionController', ['$scope', 'backupsmFactory', function ($scope, backupsmFactory) {

		var _this = this;
		var APPscope = $scope.$parent.$parent.$parent.$parent;


	}]);
}());
(function () {
	"use strict";
	backupsmApp.controller('bmBodyController', ['$rootScope', '$scope', '$filter', '$timeout', '$log', 'uuid', 'backupsmFactory', 'modalFactory', 'ApplicationsFactory', 'vmwareFactory',
		function ($rootScope, $scope, $filter, $timeout, $log, uuid, backupsmFactory, modalFactory, ApplicationsFactory, vmwareFactory) {

			var _this = this;

			this.viewSide = true;
			this.restores = [];
			this.activeRestore = null;

			/*
			 * Bindings
			 */
			$scope.$watch(function(){
				return backupsmFactory.getRestores();
			}, function(newValue){
				_this.restores = newValue;
			});

			$scope.$watch(function(){
				return backupsmFactory.getActiveRestore();
			}, function(newValue){
				_this.activeRestore = newValue;
			});

			/*
			 * Returns restore data from active restore
			 */
			this.getActiveRestore = function () {
				return $filter('filter')(_this.restores, {uuid: _this.activeRestore})[0];
			};

			/*
			 * ---------------------
			 * Outside calls
			 * ---------------------
			 */

			/*
			 * Mount Restore Datastore from Storage Snapshot
			 */
			$scope.$on('backupsm__mount_restore_datastore', function (event, data) {
				console.log(data);

				data.type = "mount_restore_datastore";
				data.restore_name = "Datastore mount (" + data.volume + ")";
				data.uuid = uuid.v4();

				$log.debug("Backups Manager [%s] -> Received event [%s] -> Initializing mount of datastore [%s] from -> storage [%s], vserver [%s], snapshot [%s]", data.uuid, event.name, data.volume, data.netapp_host, data.vserver, data.snapshot);

				backupsmFactory.setRestore(data);
				backupsmFactory.setActiveRestore(data.uuid);

				var modalInstance = modalFactory.openLittleModal('Select ESXi host', data.ESXihosts, '.window--backupsm .window__main', 'ESXiSelectable');
				modalInstance.result.then(function (host) {

					$log.debug("Backups Manager [%s] -> Received restore data from Modal -> esxi_host", data.uuid, host.host);

					data.esxi_credential = host.connection_credential;
					data.esxi_address = host.connection_address;
					data.esxi_port = host.connection_port;
					data.esxi_host = host.host;
					data.esxi_datastore_name = 'SysOS_' + data.volume_junction.substr(1);
					data.esxi_datacenter = host.datacenter;

					// Start restore
					var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Mounting ' + data.volume + ' from Snapshot...', '.window--backupsm .window__main', 'plain');

					return modalInstanceRecovery.opened.then(function () {

						return backupsmFactory.mountRestoreSnapshotDatastore(data);
					}).then(function(res) {
						if (res instanceof Error) throw new Error("Failed to mount datastore snapshot");

						$log.debug("Backups Manager [%s] -> Restore finished successfully", data.uuid);

						modalInstanceRecovery.close();
						return backupsmFactory.setRestoreStatus(data, 2);
					}).catch(function (e) {
						modalInstanceRecovery.close();

						return ApplicationsFactory.errorHandler(e.message);
					});

				}, function (rejectionResponse) {
					console.log(2, rejectionResponse);
				});

			});

			/*
			 * Restore files from Storage Snapshot
			 */
			$scope.$on('backupsm__restore_datastore_files', function (event, data) {
				console.log(data);

				data.type = "restore_datastore_files";
				data.restore_name = "Datastore restore (" + data.volume + ")";
				data.uuid = uuid.v4();

				$log.debug("Backups Manager [%s] -> Received event [%s] -> Initializing restore of datastore files [%s] from -> storage [%s], vserver [%s], snapshot [%s]", data.uuid, event.name, data.volume, data.netapp_host, data.vserver, data.snapshot);

				backupsmFactory.setRestore(data);
				backupsmFactory.setActiveRestore(data.uuid);

				var modalInstance = modalFactory.openLittleModal('Select ESXi host', data.ESXihosts, '.window--backupsm .window__main', 'ESXiSelectable');
				modalInstance.result.then(function (host) {

					$log.debug("Backups Manager [%s] -> Received restore data from Modal -> esxi_host", data.uuid, host.host);

					data.esxi_credential = host.connection_credential;
					data.esxi_address = host.connection_address;
					data.esxi_port = host.connection_port;
					data.esxi_host = host.host;
					data.esxi_datastore_name = 'SysOS_' + data.volume_junction.substr(1);
					data.esxi_datacenter = host.datacenter;

					// Start restore
					var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Restoring ' + data.volume + ' files from Snapshot...', '.window--backupsm .window__main', 'plain');

					return modalInstanceRecovery.opened.then(function () {

						return backupsmFactory.restoreSnapshotDatastoreFiles(data);
					}).then(function(res) {
						if (res instanceof Error) throw new Error("Failed to restore snapshot into datastore files");

						$log.debug("Backups Manager [%s] -> Restore finished successfully", data.uuid);

						// Open Datastore Brower application
						ApplicationsFactory.openApplication('datastoreexplorer');
						ApplicationsFactory.toggleApplication('datastoreexplorer');

						$timeout(function () {
							$rootScope.$broadcast("datastoreexplorer__restore_datastore_files", {
								credential: data.esxi_credential,
								host: data.esxi_address,
								port: data.esxi_port,
								id: data.esxi_datastore,
								name: data.esxi_datastore_name
							});
						}, 100);

						modalInstanceRecovery.close();
						return backupsmFactory.setRestoreStatus(data, 2);
					}).catch(function (e) {
						modalInstanceRecovery.close();

						return ApplicationsFactory.errorHandler(e.message);
					});

				}, function (rejectionResponse) {
					console.log(2, rejectionResponse);
				});

			});

			/*
			 * Restore VM guest files from Storage Snapshot
			 */
			$scope.$on('backupsm__restore_vm_guest_files', function (event, data) {
				console.log(data);

				data.type = "restore_vm_guest_files";
				data.restore_name = "VM guest files (" + data.vm.name + ")";
				data.uuid = uuid.v4();

				$log.debug("Backups Manager [%s] -> Received event [%s] -> Initializing restore of VM guest files [%s] from -> storage [%s], vserver [%s], datastore [%s], snapshot [%s]", data.uuid, event.name, data.vm.name, data.netapp_host, data.vserver, data.volume, data.snapshot);

				backupsmFactory.setRestore(data);
				backupsmFactory.setActiveRestore(data.uuid);

				var modalInstance = modalFactory.openLittleModal('PLEASE WAIT', data.ESXihosts, '.window--backupsm .window__main', 'ESXiSelectable');
				modalInstance.result.then(function (host) {

					$log.debug("Backups Manager [%s] -> Received restore data from Modal -> esxi_host", data.uuid, host.host);

					data.esxi_credential = host.connection_credential;
					data.esxi_address = host.connection_address;
					data.esxi_port = host.connection_port;
					data.esxi_host = host.host;
					data.esxi_datastore_name = 'SysOS_' + data.volume_junction.substr(1);

					// Start restore
					var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Restoring ' + data.vm.name + ' guest files from Snapshot...', '.window--backupsm .window__main', 'plain');

					return modalInstanceRecovery.opened.then(function () {

						return backupsmFactory.restoreSnapshotVMGuestFiles(data);
					}).then(function(res) {
						if (res instanceof Error) throw new Error("Failed to restore snapshot into VM guest files");

						$log.debug("Backups Manager [%s] -> Restore finished successfully", data.uuid);

						modalInstanceRecovery.close();
						return backupsmFactory.setRestoreStatus(data, 2);
					}).catch(function (e) {
						modalInstanceRecovery.close();

						return ApplicationsFactory.errorHandler(e.message);
					});

				}, function (rejectionResponse) {
					console.log(2, rejectionResponse);
				});

			});

			/*
			 * VM Instant Recovery from Storage Snapshot
			 */
			$scope.$on('backupsm__vm_instant_recovery', function (event, data) {
				console.log(data);

				data.type = "vm_instant_recovery";
				data.restore_name = "VM instant recovery (" + data.vm.name + ")";
				data.uuid = uuid.v4();

				$log.debug("Backups Manager [%s] -> Received event [%s] -> Initializing restore of VM [%s] from -> storage [%s], vserver [%s], datastore [%s], snapshot [%s]", data.uuid, event.name, data.vm.name, data.netapp_host, data.vserver, data.volume, data.snapshot);

				backupsmFactory.setRestore(data);
				backupsmFactory.setActiveRestore(data.uuid);

				// User must select ESXi host and its data
				var modalInstanceRestoreVM = modalFactory.openWizardModal('Select required data for Instant VM', data, '.window--backupsm .window__main', 'recoveryWizard');
				modalInstanceRestoreVM.result.then(function (res) {

					$log.debug("Backups Manager [%s] -> Received restore data from Modal -> esxi_host [%s], folder [%s], resource_pool [%s], vm_name [%s], vm_power_on [%s]", data.uuid, res.host.host, res.folder.folder, res.resource_pool.resource_pool, res.vm_name, res.vm_power_on);

					data.esxi_credential = res.host.connection_credential;
					data.esxi_address = res.host.connection_address;
					data.esxi_port = res.host.connection_port;
					data.esxi_host = res.host.host;
					data.esxi_datastore_name = 'SysOS_' + data.volume_junction.substr(1);
					data.folder = res.folder.folder;
					data.resource_pool = res.resource_pool.resource_pool;
					data.vm_name = res.vm_name;
					data.vm_power_on = res.vm_power_on;

					// Start restore
					var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Restoring ' + data.vm.name + ' from Snapshot...', '.window--backupsm .window__main', 'plain');

					return modalInstanceRecovery.opened.then(function () {

						return backupsmFactory.restoreSnapshotIntoInstantVM(data);
					}).then(function(res) {
						if (res instanceof Error) throw new Error("Failed to restore snapshot into Instant VM");

						$log.debug("Backups Manager [%s] -> Restore finished successfully -> instant_vm [%s]", data.uuid, data.vm_id);

						modalInstanceRecovery.close();
						return backupsmFactory.setRestoreStatus(data, 2);
					}).catch(function (e) {
						modalInstanceRecovery.close();

						return ApplicationsFactory.errorHandler(e.message);
					});

				}, function (rejectionResponse) {
					console.log(2, rejectionResponse);
				});

			});

			/*
			 * ng-click functions
			 */
			this.toggleSide = function () {
				_this.viewSide = !_this.viewSide;
			};

			this.openDatastoreBrowser = function () {
				// Open Datastore Brower application
				ApplicationsFactory.openApplication('datastoreexplorer');
				ApplicationsFactory.toggleApplication('datastoreexplorer');

				var data = _this.getActiveRestore();

				$timeout(function () {
					$rootScope.$broadcast("datastoreexplorer__restore_datastore_files", {
						credential: data.esxi_credential,
						host: data.esxi_address,
						port: data.esxi_port,
						id: data.esxi_datastore,
						name: data.esxi_datastore_name
					});
				}, 100);
			};

			this.unpublishRestoredInstantVM = function () {
				var current_restore = _this.getActiveRestore();

				var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Initializing restore from Snapshot rollback...', '.window--backupsm .window__main', 'plain');

				return modalInstanceRecovery.opened.then(function () {

					return vmwareFactory.connectvCenterSoap(current_restore.esxi_credential, current_restore.esxi_address, current_restore.esxi_port);
				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to connect to vCenter");

					return backupsmFactory.unpublishVM(current_restore);
				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to unpublish VM from vCenter");

					return backupsmFactory.unmountDatastore(current_restore);
				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to unmount volume");

					return backupsmFactory.destroyVolume(current_restore);
				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to destroy volume");

					modalFactory.changeModalText('Saving results...', '.window--backupsm .window__main');
					return backupsmFactory.setRestoreStatus(current_restore, "mounted_to_esx");
				}).then(function () {
					return modalInstanceRecovery.close();

				}).catch(function (e) {
					modalInstanceRecovery.close();

					return ApplicationsFactory.errorHandler(e.message);
				});

			};

			this.unpublishRestoredDatastore = function () {
				var current_restore = _this.getActiveRestore();

				var modalInstanceRecovery = modalFactory.openLittleModal('PLEASE WAIT', 'Initializing restore from Snapshot rollback...', '.window--backupsm .window__main', 'plain');

				return modalInstanceRecovery.opened.then(function () {

					return vmwareFactory.connectvCenterSoap(current_restore.esxi_credential, current_restore.esxi_address, current_restore.esxi_port);
				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to connect to vCenter");

					return backupsmFactory.unmountDatastore(current_restore);
				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to unmount volume");

					return backupsmFactory.destroyVolume(current_restore);
				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to destroy volume");

					modalFactory.changeModalText('Saving results...', '.window--backupsm .window__main');
					return backupsmFactory.setRestoreStatus(current_restore, "init");
				}).then(function () {
					return modalInstanceRecovery.close();

				}).catch(function (e) {
					modalInstanceRecovery.close();

					return ApplicationsFactory.errorHandler(e.message);
				});

			};

			this.setActiveRestore = function (restore) {
				return backupsmFactory.setActiveRestore(restore.uuid)
			};

		}]);
}());
(function () {
	"use strict";
	backupsmApp.factory('backupsmFactory', ['$filter', 'netappFactory', 'vmwareFactory', 'ServerFactory', 'ApplicationsFactory', 'modalFactory',
		function ($filter, netappFactory, vmwareFactory, ServerFactory, ApplicationsFactory, modalFactory) {

			var restores = [];
			var activeRestore;

			/*
			 * -------------------
			 * PRIVATE FUNCTIONS
			 * -------------------
			 */

			/*
			 * Clones Storage Volume from Snapshot
			 */
			var cloneVolumeFromSnapshot = function (data) {

				// Create Volume Clone
				return netappFactory.cloneVolumeFromSnapshot(data.netapp_credential, data.netapp_host, data.netapp_port, data.vserver, data.volume, data.snapshot).then(function (res) {
					if (res.status === "error") throw new Error("Failed to clone Volume");

					return setRestoreStatus(data, "cloned");
				}).then(function () {

					// Mount Volume Point
					return netappFactory.mountVolume(data.netapp_credential, data.netapp_host, data.netapp_port, data.vserver, data.volume);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to mount Volume");

					// TODO: check Storage EXPORTS
					// TODO: Create export
					return setRestoreStatus(data, "mounted");

				}).catch(function (e) {
					console.log(e);
					return e;
				});
			};

			/*
			 * Mount storage Datastore to ESXi host
			 */
			var mountVolumeToESXi = function (data) {

				return vmwareFactory.connectvCenterSoap(data.esxi_credential, data.esxi_address, data.esxi_port).then(function (res) {
					if (res.status === "error") throw new Error("Failed to connect to vCenter");

					// TODO: check connectivity from NFS node
					return vmwareFactory.getHostConfigManagerNetworkSystem(data.esxi_credential, data.esxi_address, data.esxi_port, data.esxi_host);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get networkSystem from vCenter");

					data.networkSystem = res.data;

					// Get Datastore System from ESXi host to mount
					return vmwareFactory.getHostConfigManagerDatastoreSystem(data.esxi_credential, data.esxi_address, data.esxi_port, data.esxi_host);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get datastoreSystem from vCenter");

					data.datastoreSystem = res.data;

					// TODO: check connectivity from NFS node
					return vmwareFactory.getHostNetworkInfoVnic(data.esxi_credential, data.esxi_address, data.esxi_port, data.networkSystem);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get NetworkInfoVnic from vCenter");

					// TODO: check connectivity from NFS node
					return vmwareFactory.getHostNetworkInfoConsoleVnic(data.esxi_credential, data.esxi_address, data.esxi_port, data.networkSystem);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get NetworkInfoConsoleVnic from vCenter");

					return vmwareFactory.mountDatastore(data.esxi_credential, data.esxi_address, data.esxi_port, data.datastoreSystem, data.netapp_nfs_ip[0].address, '/SysOS_' + data.volume + '_Restore/', 'SysOS_' + data.volume_junction.substr(1));

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to mount Datastore to host");

					// Get mounted datastore name
					data.esxi_datastore = res.data;
					return setRestoreStatus(data, "mounted_to_esx");

				}).then(function (res) {
					console.log(res);
					if (res.status === "error") throw new Error("Failed to get Datastores from vCenter");

					return vmwareFactory.getDatastoreProps(data.esxi_credential, data.esxi_address, data.esxi_port, data.esxi_datastore);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get Datastore Properties from vCenter");

				}).catch(function (e) {
					console.log(e);
					return e;
				});
			};

			/*
			 * Register and power on VM
			 */
			var registerVM = function (data) {

				// Get VM in Datastore
				return vmwareFactory.getVMFileDataFromDatastore(
					data.esxi_credential,
					data.esxi_address,
					data.esxi_port,
					data.esxi_datastore,
					'SysOS_' + data.volume_junction.substr(1),
					data.vm.path.substring(0, data.vm.path.lastIndexOf("/") + 1).substr(1),
					data.vm.path.split('/').pop()
				).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get files from datastore");

					// Register VM
					return vmwareFactory.registerVM(
						data.esxi_credential,
						data.esxi_address,
						data.esxi_port,
						data.esxi_host,
						'[SysOS_' + data.volume_junction.substr(1) + '] ' + data.vm.path,
						data.vm_name,
						data.folder,
						data.resource_pool
					);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to register VM to vCenter");

					data.vm_id = res.data.result.name;
					return setRestoreStatus(data, "vm_registred");
				}).then(function () {

					if (data.vm_power_on) {
						// Power On VM
						return vmwareFactory.powerOnVM(data.esxi_credential, data.esxi_address, data.esxi_port, data.esxi_host, data.vm_id);
					}

				}).then(function (res) {
					if (res && res.status === "error") throw new Error("Failed to power on VM on vCenter");

				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};


			/*
			 * -------------------
			 * PUBLIC FUNCTIONS
			 * -------------------
			 */

			/*
			 *   - Keeps a track of restore point and updates it to backend.
			 */
			var setRestoreStatus = function (data, status) {
				$filter('filter')(restores, {uuid: data.uuid})[0].status = status;

				return ServerFactory.saveConfigToFile(data, 'applications/backupsm/restores.json', false);
			};

			/*
			* mountRestoreSnapshotDatastore
			*/
			var mountRestoreSnapshotDatastore = function (data) {

				// Create Volume Clone
				return cloneVolumeFromSnapshot(data).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to clone volume from snapshot");

					// Mount Volume
					return mountVolumeToESXi(data);

				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to mount cloned volume from snapshot to ESXi host");

				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};

			/*
			 * restoreSnapshotDatastoreFiles
			 */
			var restoreSnapshotDatastoreFiles = function (data) {

				// Create Volume Clone
				return cloneVolumeFromSnapshot(data).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to clone volume from snapshot");

					// Mount Volume
					return mountVolumeToESXi(data);

				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to mount cloned volume from snapshot to ESXi host");

				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};

			/*
			 * restoreSnapshotVMGuestFiles
			 */
			var restoreSnapshotVMGuestFiles = function (data) {

				// Create Volume Clone
				return cloneVolumeFromSnapshot(data).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to clone volume from snapshot");

					// Mount Volume
					return mountVolumeToESXi(data);

				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to mount cloned volume from snapshot to ESXi host");

					// Get VM in Datastore
					return vmwareFactory.getVMFileDataFromDatastore(
						data.esxi_credential,
						data.esxi_address,
						data.esxi_port,
						data.esxi_datastore,
						'SysOS_' + data.volume_junction.substr(1),
						data.vm.path.substring(0, data.vm.path.lastIndexOf("/") + 1).substr(1),
						data.vm.path.split('/').pop()
					);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get files from datastore");

					// Register VM
					return vmwareFactory.registerVM(
						data.esxi_credential,
						data.esxi_address,
						data.esxi_port,
						data.esxi_host,
						'[SysOS_' + data.volume_junction.substr(1) + '] ' + data.vm.path,
						data.vm_name,
						data.folder,
						data.resource_pool
					);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to register VM to vCenter");
					return res;



				}).catch(function (e) {
					return e;
				});

			};

			/*
			 * restoreSnapshotVMInstantMachine
			 */
			var restoreSnapshotIntoInstantVM = function (data) {

				// Create Volume Clone
				return cloneVolumeFromSnapshot(data).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to clone volume from snapshot");

					// Mount Volume
					return mountVolumeToESXi(data);

				}).then(function (res) {
					if (res instanceof Error) throw new Error("Failed to mount cloned volume from snapshot to ESXi host");

					return registerVM(data);
				}).then(function(res) {
					if (res instanceof Error) throw new Error("Failed to register VM from snapshot to ESXi host");

					return res;

				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};

			/*
			 * Unpublish VM
			 */
			var unpublishVM = function (data) {

				modalFactory.changeModalText('Connecting to vCenter...', '.window--backupsm .window__main');
				return vmwareFactory.connectvCenterSoap(data.esxi_credential, data.esxi_address, data.esxi_port).then(function (res) {
					if (res.status === "error") throw new Error("Failed to connect to vCenter");

					// Check if VM is powered on
					return vmwareFactory.getVMState(data.esxi_credential, data.esxi_address, data.esxi_port, data.vm_id)

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to get VM state from vCenter");

					// VM not found
					if (res && res.data.hasOwnProperty("ManagedObjectNotFoundFault")) return res;

					// Power Off VM
					if (res.data["runtime.powerState"] === "poweredOn") {
						modalFactory.openLittleModal('PLEASE WAIT', 'Powering off VM ...', '.window--backupsm .window__main', 'plain');
						return vmwareFactory.powerOffVM(data.esxi_credential, data.esxi_address, data.esxi_port, data.vm_id);
					}

					// VM is Powered Off
					return res;

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to power off VM at vCenter");

					// VM not found
					if (res && res.data.hasOwnProperty("ManagedObjectNotFoundFault")) return res;

					// Unregister VM
					modalFactory.openLittleModal('PLEASE WAIT', 'Unregistering VM ...', '.window--backupsm .window__main', 'plain');
					return vmwareFactory.unregisterVM(data.esxi_credential, data.esxi_address, data.esxi_port, data.vm_id);

				}).then(function (res) {
					if (res.status === "error") throw new Error("Failed to unregister VM from vCenter");

					return setRestoreStatus(data, "unregistred_vm");
				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};

			/*
			 * Unmount Datastore
			 */
			var unmountDatastore = function (data) {

				// Unregister Datastore
				modalFactory.changeModalText('Unmounting datastore...', '.window--backupsm .window__main');
				return vmwareFactory.unmountDatastore(data.esxi_credential, data.esxi_address, data.esxi_port, data.datastoreSystem, data.esxi_datastore).then(function (res) {
					if (res.status === "error") throw new Error("Failed to unmount datastore from vCenter");

					return setRestoreStatus(data, "unmounted_datastore");
				}).catch(function (e) {
					console.log(e);
					return e;
				});

			};

			/*
			 * Destroy Storage Volume
			 */
			var destroyVolume = function (data) {

				// Unmount NetApp Volume
				modalFactory.changeModalText('Unmounting storage volume...', '.window--backupsm .window__main');
				return netappFactory.unmountVolume(data.netapp_credential, data.netapp_host, data.netapp_port, data.vserver, data.volume).then(function (res) {
					if (res.status === "error" || res.data !== "passed") throw new Error("Failed to unmount volume");

					return setRestoreStatus(data, "netapp_datastore_unmounted");
				}).then(function () {

					// Set NetApp Volume Offline
					modalFactory.changeModalText('Setting volume offline...', '.window--backupsm .window__main');
					return netappFactory.setVolumeOffline(data.netapp_credential, data.netapp_host, data.netapp_port, data.vserver, data.volume);

				}).then(function (res) {
					if (res.status === "error" || res.data !== "passed") throw new Error("Failed to set volume offline");

					return setRestoreStatus(data, "netapp_datastore_offline");
				}).then(function () {

					// Destroy NetApp Volume
					modalFactory.changeModalText('Destroying volume...', '.window--backupsm .window__main');
					return netappFactory.destroyVolume(data.netapp_credential, data.netapp_host, data.netapp_port, data.vserver, data.volume);

				}).then(function (res) {
					if (res.status === "error" || res.data !== "passed") throw new Error("Failed to destroy volume");

					return setRestoreStatus(data, 3);
				}).catch(function (e) {
					console.log(e);
					return e;
				});
			};

			/*
			 * create SnapShot
			 */
			var createSnapShot = function () {

			};

			return {
				setRestores: function (data) {
					restores = data;
				},
				getRestores: function () {
					return restores;
				},
				getActiveRestore: function () {
					return activeRestore;
				},
				setRestore: function (data) {
					data.status = "init";
					return restores.push(data);
				},
				setActiveRestore: function (uuid) {
					return activeRestore = uuid;
				},
				setRestoreStatus: setRestoreStatus,
				mountRestoreSnapshotDatastore: mountRestoreSnapshotDatastore,
				restoreSnapshotVMGuestFiles: restoreSnapshotVMGuestFiles,
				restoreSnapshotDatastoreFiles: restoreSnapshotDatastoreFiles,
				restoreSnapshotIntoInstantVM: restoreSnapshotIntoInstantVM,
				unpublishVM: unpublishVM,
				unmountDatastore: unmountDatastore,
				destroyVolume: destroyVolume,
				createSnapShot: createSnapShot
			}


		}]);
}());
(function () {
	"use strict";
	backupsmApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/actions-backupsm.html',
			'<div class="window__actions" ng-controller="bmActionController as bmA"> \
			  <a class="window__item"  title="New connection" ng-click="bmA.newConnection()"> \
				<i class="fa fa-plus text-success"></i> \
			  </a> \
			  <a class="window__item separator" ></a> \
			  <a class="window__item separator" ></a> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	backupsmApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/body-backupsm.html',
			'<div class="window__body" ng-controller="bmBodyController as bmB"> \
			  <div class="window__side" ng-if="bmB.viewSide"> \
				<div class="menu__item" ng-repeat="restore in bmB.restores track by $index" ng-class="{\'active\': restore.uuid == bmB.activeRestore}" ng-click="bmB.setActiveRestore(restore)" ng-if="restore != undefined"> \
				  <h5>{{::restore.restore_name}}<br /><small>{{::restore.snapshot}}</small></h5> \
				</div> \
				<div class="secondary-content__new__box__toggle pointer visible-lg"> \
				  <div class="secondary-content__new__box__toggle__slide" ng-click="bmB.toggleSide()"> \
					<i class="fa fa-arrow-left sidebar-open-font open-sidebar"></i> \
				  </div> \
				</div> \
			  </div> \
			  <div class="secondary-content__new__box__toggle toggle_left pointer visible-lg" ng-if="!bmB.viewSide" ng-click="bmB.toggleSide()"> \
				<i class="fa fa-arrow-right sidebar-open-font open-sidebar"></i> \
			  </div> \
			  <div class="window__main"> \
				<div ng-if="bmB.getActiveRestore().type == \'mount_restore_datastore\'"> \
				  <div ng-if ="bmB.getActiveRestore().status == 2"> \
					<button class="btn btn-primary" type="button" ng-click="bmB.unpublishRestoredDatastore()">Stop Publishing Datastore</button> \
					<button class="btn btn-primary" type="button" ng-click="bmB.openDatastoreBrowser()">Open Datastore Browser</button> \
				  </div> \
				  Restore status: {{bmB.getActiveRestore().status}} \
				</div> \
				<div ng-if="bmB.getActiveRestore().type == \'restore_datastore_files\'"> \
				  <div ng-if ="bmB.getActiveRestore().status == 2"> \
					<button class="btn btn-primary" type="button" ng-click="bmB.unpublishRestoredDatastore()">Stop Publishing Datastore</button> \
					<button class="btn btn-primary" type="button" ng-click="bmB.openDatastoreBrowser()">Open Datastore Browser</button> \
				  </div> \
				  Restore status: {{bmB.getActiveRestore().status}} \
				</div> \
				<div ng-if="bmB.getActiveRestore().type == \'restore_vm_guest_files\'"> \
				  Restore status: {{bmB.getActiveRestore().status}} \
				</div> \
				<div ng-if="bmB.getActiveRestore().type == \'vm_instant_recovery\'"> \
				  <div ng-if ="bmB.getActiveRestore().status == 2"> \
					<button class="btn btn-primary" type="button" ng-click="bmB.unpublishRestoredInstantVM()">Stop Publishing Instant VM</button> \
					<button class="btn btn-primary" type="button" ng-click="bmB.migrateInstantVMtoProduction()">Migrate Instant VM to Production</button> \
				  </div> \
				  Restore status: {{bmB.getActiveRestore().status}} \
				</div> \
			  </div> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	backupsmApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/menu-backupsm.html',
			'<li> \
			  <a > \
				<i class="menu__icon fa fa-search"></i> \
				Search \
			  </a> \
			</li> \
			<li> \
			  <a > \
				<i class="menu__icon fa fa-share-alt"></i> \
				Share \
			  </a> \
			</li> \
			<li> \
			  <a > \
				<i class="menu__icon fa fa-plug"></i> \
				Devices \
			  </a> \
			</li> \
			<li class="divided"> \
			  <a > \
				<i class="menu__icon fa fa-cog"></i> \
				Settings \
			  </a> \
			</li>'
		);

	}]);
}());
(function () {
	"use strict";
	backupsmApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/new-connection-type-backupsm.html',
			'<div class="main_form"> \
			  <p>Select the type of server you want to register with managed infrastructure. All registred servers can be found under the Manager servers node on the Infrastructure tab.</p> \
			  <table class="table table-hover m-t-xl"> \
			  </table> \
			</div>'
		);

	}]);
}());
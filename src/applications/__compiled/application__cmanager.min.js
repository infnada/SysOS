/**
Systems OS - 0.0.1

Copyright (c) 2018 Isart Navarro Farell
License: MIT
*/
var cmanagerApp = angular.module('cmanagerApp', []);

(function () {
	"use strict";
	cmanagerApp.run(['ApplicationsFactory', 'ServerFactory', 'cmanagerFactory', function(ApplicationsFactory, ServerFactory, cmanagerFactory) {

		ApplicationsFactory.registerApplication({
			id: "cmanager",
			ico: "key",
			name: "Credentials Manager",
			menu: true,
			actions: true,
			status: true,
			style: "width:870px;height:600px;top:7%;left:10%;"
		});

		// Get all credentials
		ServerFactory
		.applicationInitCredentials(function (data) {
			return cmanagerFactory.setSavedCredentials(data.data);
		}, function () {
			console.log("Error");
		});

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.controller('cmanagerActionController', ['$scope', 'cmanagerFactory', function ($scope, cmanagerFactory) {

		var _this = this;
		var APPscope = $scope.$parent.$parent.$parent.$parent;

		/*
		 * Bindings
		 */

		$scope.$watch(function(){
			return cmanagerFactory.credentials();
		}, function(newValue, oldValue){
			_this.credentials = newValue;
		});

		$scope.$watch(function(){
			return cmanagerFactory.activeCredential();
		}, function(newValue){
			_this.activeCredential = newValue;
		});


		/*
		 * ng-click functions
		 */
		this.newCredential = function () {
			if (_this.activeCredential == null) return
			APPscope.$broadcast('cmanager__new_credential');
		};

		this.deleteCredential = function () {
			if (_this.activeCredential == null) return
			APPscope.$broadcast('cmanager__delete_credential');
		};


	}]);
}());
(function () {
	"use strict";
	cmanagerApp.controller('cmanagerBodyController', ['$scope', 'cmanagerFactory', 'ServerFactory', function ($scope, cmanagerFactory, ServerFactory) {

		var _this = this;

		/*
		 * Bindings
		 */
		this.viewSide = true;
		this.resizeId;

		this.Form = {};
		this.cmanagerCredential_form = {};

		$scope.$watch(function(){
			return cmanagerFactory.credentials();
		}, function(newValue, oldValue){
			_this.credentials = newValue;
		});

		$scope.$watch(function(){
			return cmanagerFactory.activeCredential();
		}, function(newValue){
			_this.activeCredential = newValue;
		});

		/*
		 * Called at cmanagerActionController
		 */
		$scope.$on('cmanager__new_credential', function(event) {
			cmanagerFactory.setActiveCredential(null);
			_this.Form = {};
			_this.cmanagerCredential_form = {};
		});

		/*
		 * Called at cmanagerActionController
		 */
		$scope.$on('cmanager__delete_credential', function(event) {
			cmanagerFactory.deleteCredential(_this.activeCredential);
			_this.Form = {};
			_this.cmanagerCredential_form = {};
		});


		/*
		 * ng-click functions
		 */
		this.toggleSide = function () {
			_this.viewSide = !_this.viewSide;
		};

		this.sendSave = function (cmanagerCredential_form) {
			_this.cmanagerCredential_form.submitted = true;

			if (cmanagerCredential_form.$valid) {
				_this.cmanagerCredential_form.submitted = false;
				cmanagerFactory.saveCredential(_this.Form);
				_this.Form = {};
				_this.cmanagerCredential_form = {};
			}
		};

		this.setActiveCredential = function (credential) {
			cmanagerFactory.setActiveCredential(credential.uuid);
			_this.Form = angular.copy(credential);
		};

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.controller('cmanagerStatusController', ['$scope', 'cmanagerFactory', function ($scope, cmanagerFactory) {

		var _this = this;

		/*
		 * Bindings
		 */

		$scope.$watch(function(){
			return cmanagerFactory.credentials();
		}, function(newValue, oldValue){
			_this.credentials = newValue;
		});

		$scope.$watch(function(){
			return cmanagerFactory.activeCredential();
		}, function(newValue){
			_this.activeCredential = newValue;
		});

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.factory('cmanagerFactory', ['$filter', 'ServerFactory', 'toastr', function ($filter, ServerFactory, toastr) {

		// Private
		var credentials = [];
		var activeCredential = null;

		var deleteCredential = function (uuid) {
			credentials = credentials.filter(function(el) {
				return el.uuid !== uuid;
			});

			return ServerFactory.deleteCredential(uuid, function (data) {

				toastr.success('Credential Manager', 'Credential deleted!');
				activeCredential = null;

			}, function () {

				return toastr.error('Credential Manager', 'Error deleting credential!');

			});

		};

		var saveCredential = function (credential) {

			return ServerFactory.saveCredential(credential, function (data) {

				if ($filter('filter')(credentials, {uuid: data.data.data.response})[0]) {
					$filter('filter')(credentials, {uuid: data.data.data.response})[0].description = credential.description;
					$filter('filter')(credentials, {uuid: data.data.data.response})[0].username = credential.username;
				} else {
					credentials.push({
						uuid: data.data.data.response,
						description: credential.description,
						username: credential.username
					});
				}

				toastr.success('Credential Manager', 'Credential saved!');
				activeCredential = null;

			}, function () {

				return toastr.error('Credential Manager', 'Error saving credential!');

			});

		};


		return {
			setSavedCredentials: function (data) {
				credentials = data;
			},
			credentials: function () {
				return credentials;
			},
			setActiveCredential: function (uuid) {
				activeCredential = uuid;
			},
			activeCredential: function () {
				return activeCredential;
			},
			saveCredential: saveCredential,
			deleteCredential: deleteCredential
		};

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/actions-cmanager.html',
			'<div class="window__actions" ng-controller="cmanagerActionController as cmanagerA"> \
			  <a class="window__item"  title="New Credential" ng-click="cmanagerA.newCredential()"> \
				<i class="fa fa-plus text-success"></i> \
			  </a> \
			  <a class="window__item separator" ></a> \
			  <a class="window__item"  title="Delete Current Credential" ng-click="cmanagerA.deleteCredential()"> \
				<i class="fa fa-close" ng-class="{\'text-danger\': cmanagerA.activeCredential != null}"></i> \
			  </a> \
			  <a class="window__item separator"></a> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/body-cmanager.html',
			'<div class="window__body with_status" ng-controller="cmanagerBodyController as cmanagerB"> \
			  <div class="window__side" ng-if="cmanagerB.viewSide"> \
				<div class="menu__item" ng-repeat="credential in cmanagerB.credentials track by $index" ng-class="{\'active\': credential.uuid == cmanagerB.activeCredential}" ng-click="cmanagerB.setActiveCredential(credential)" ng-if="credential != undefined"> \
				  <h5> \
					{{credential.description}} <small>({{credential.username}})</small> \
				  </h5> \
				</div> \
				<div class="secondary-content__new__box__toggle pointer visible-lg"> \
				  <div class="secondary-content__new__box__toggle__slide" ng-click="cmanagerB.toggleSide()"> \
					<i class="fa fa-arrow-left sidebar-open-font open-sidebar"></i> \
				  </div> \
				</div> \
			  </div> \
			  <div class="secondary-content__new__box__toggle toggle_left pointer visible-lg" ng-if="!cmanagerB.viewSide" ng-click="cmanagerB.toggleSide()"> \
				<i class="fa fa-arrow-right sidebar-open-font open-sidebar"></i> \
			  </div> \
			  <div class="window__main no_padding"> \
				<div> \
				  <form class="main_form form-horizontal" name="cmanagerCredential_form" ng-submit="cmanagerB.sendSave(cmanagerCredential_form)"> \
					<div class="form-group"> \
					  <div class="col-sm-12"> \
						<input type="text" class="form-control" name="inputDescription" placeholder="Description" ng-model="cmanagerB.Form.description" required> \
					  </div> \
					  <div class="col-sm-12" ng-show="cmanagerCredential_form.inputDescription.$invalid && cmanagerB.cmanagerCredential_form.submitted"> \
						<small class="text-danger pull-left" ng-show="cmanagerCredential_form.inputDescription.$error.required">Please insert a description</small> \
					  </div> \
					</div> \
					<div class="form-group"> \
					  <div class="col-sm-12"> \
						<input type="text" class="form-control" name="inputUsername" placeholder="Username" ng-model="cmanagerB.Form.username" required> \
					  </div> \
					  <div class="col-sm-12" ng-show="cmanagerCredential_form.inputUsername.$invalid && cmanagerB.cmanagerCredential_form.submitted"> \
						<small class="text-danger pull-left" ng-show="cmanagerCredential_form.inputUsername.$error.required">Please insert an username</small> \
					  </div> \
					</div> \
					<div class="form-group"> \
					  <div class="col-sm-12"> \
						<input type="password" class="form-control" name="inputPassword" placeholder="Password" ng-model="cmanagerB.Form.password" required> \
					  </div> \
					  <div class="col-sm-12" ng-show="cmanagerCredential_form.inputPassword.$invalid && cmanagerB.cmanagerCredential_form.submitted"> \
						<small class="text-danger pull-left" ng-show="cmanagerCredential_form.inputPassword.$error.required">Please insert a password</small> \
					  </div> \
					</div> \
					<div> \
					  <button type="submit" class="btn btn-default">Save</button> \
					</div> \
				  </form>\
				</div> \
			  </div> \
			</div>'
		);

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/menu-cmanager.html',
			'<li> \
		  <a > \
			<i class="menu__icon fa fa-download"></i> \
			Save \
		  </a> \
		</li> \
		<li> \
		  <a > \
			<i class="menu__icon fa fa-folder-open"></i> \
			Open \
		  </a> \
		</li> \
		<li> \
		  <a > \
			<i class="menu__icon fa fa-print"></i> \
			Print \
		  </a> \
		</li> \
		<li> \
			<a > \
			  <i class="menu__icon fa fa-share-alt"></i> \
			  Share \
			</a> \
		  </li> \
		  <li class="divided"> \
			<a > \
			  <i class="menu__icon fa fa-file"></i> \
			  Format \
			</a> \
		</li> \
		<li> \
			<a > \
			  <i class="menu__icon fa fa-cog"></i> \
			  Settings \
		  </a> \
		</li>'
		);

	}]);
}());
(function () {
	"use strict";
	cmanagerApp.run(['$templateCache', function($templateCache) {

		$templateCache.put('templates/applications/status-cmanager.html',
			'<div class="window__status" ng-controller="cmanagerStatusController as cmanagerS"> \
			  <span class="pull-right text-success" ng-if="!cmanagerS.cmanagererror">{{cmanagerS.status}}</span> \
			  <span class="pull-right text-danger" ng-if="cmanagerS.cmanagererror">{{cmanagerS.cmanagererror}}</span> \
			</div>'
		);

	}]);
}());
/**
Systems OS - 0.0.1

Copyright (c) 2018 Isart Navarro Farell
License: MIT
*/
var wmksApp = angular.module('wmksApp', []);

(function () {
    'use strict';
    wmksApp.run(['ApplicationsFactory', function (ApplicationsFactory) {

        ApplicationsFactory.registerApplication({
            id: 'wmks',
            ico: 'television',
            name: 'VM Remote Console',
            menu: true,
            style: 'width:90%;height:90%;top:2%;left:5%;'
        });

    }]);
}());
(function () {
    'use strict';
    wmksApp.controller('wmksBodyController', ['$scope', 'vmwareFactory', 'toastr', function ($scope, vmwareFactory, toastr) {

        var _this = this;
        var wmksData;

        $scope.$on('wmks__new_data', function (event, data) {
            wmksData = data;

            return vmwareFactory.connectvCenterSoap(wmksData.credential, wmksData.host, wmksData.port).then(function (res) {
                if (res.status === 'error') throw new Error('Failed to connect to vCenter');

                return vmwareFactory.acquireVMTicket(wmksData.credential, wmksData.host, wmksData.port, wmksData.vm);

            }).then(function (res) {
                if (res.status === 'error') throw new Error('Failed to acquire VM ticket');

                var _wmks = $('#wmksContainer')
                .wmks({'useVNCHandshake': false, 'sendProperMouseWheelDeltas': true, 'fitToParent': true})
                .bind('wmksconnecting', function () {
                    console.log('The console is connecting');
                })
                .bind('wmksconnected', function () {
                    console.log('The console has been connected');
                })
                .bind('wmksdisconnected', function (evt, info) {
                    console.log('The console has been disconnected');
                    console.log(evt, info);
                })
                .bind('wmkserror', function (evt, errObj) {
                    console.log('Error!');
                    console.log(evt, errObj);
                    toastr.error('Make sure that you have access to ESXi host (' + res.data.host[0] + ':' + res.data.port[0] + ') and it\'s certificate is trusted', 'Unable to open remote console to VM (' + wmksData.vm + ')');
                })
                .bind('wmksiniterror', function (evt, customData) {
                    console.log(evt);
                    console.log(customData);
                })
                .bind('wmksresolutionchanged', function (canvas) {
                    console.log('Resolution has changed!');
                });

                _this.url = 'wss://' + res.data.host[0] + ':' + res.data.port[0] + '/ticket/' + res.data.ticket[0];
                _wmks.wmks('connect', _this.url);

            });
        });

    }]);
}());
(function () {
    'use strict';
    wmksApp.run(['$templateCache', function ($templateCache) {

        $templateCache.put('templates/applications/body-wmks.html',
            '<div class="window__body" ng-controller="wmksBodyController as wmksB"> \
              <div class="window__main no_padding"> \
                <div id="wmksContainer" style="width:100%; height:100%;"></div> \
              </div> \
            </div>'
        );

    }]);
}());
(function () {
    'use strict';
    wmksApp.run(['$templateCache', function ($templateCache) {

        $templateCache.put('templates/applications/menu-wmks.html',
            '<li> \
          <a > \
            <i class="menu__icon fa fa-download"></i> \
            Save \
          </a> \
        </li> \
        <li> \
          <a > \
            <i class="menu__icon fa fa-folder-open"></i> \
            Open \
          </a> \
        </li> \
        <li> \
          <a > \
            <i class="menu__icon fa fa-print"></i> \
            Print \
          </a> \
        </li> \
        <li> \
          <a > \
            <i class="menu__icon fa fa-share-alt"></i> \
            Share \
          </a> \
        </li> \
        <li class="divided"> \
          <a > \
            <i class="menu__icon fa fa-file"></i> \
            Format \
          </a> \
        </li> \
        <li> \
          <a > \
            <i class="menu__icon fa fa-cog"></i> \
            Settings \
          </a> \
        </li>'
        );

    }]);
}());